# State version
version: 2.0
jobs:
  # Install php dependencies
  install-php:
    docker:
      - image: php:7.3-alpine
    steps:
      # Now checkout the code
      - checkout:
          path: /src
      # Install composer
      - run: apk add --no-progress composer
      # Install bedrock dependencies
      - run:
          name: Install bedrock dependencies
          command: composer install -o --no-progress --prefer-dist --no-interaction
          working_directory: /src/site
      # Install plugin dependencies
      - run:
          name: Install plugin dependencies
          command: composer install -o --no-progress --prefer-dist --no-interaction
          working_directory: /src/site/web/app/mu-plugins/skin-deep
      # Install theme dependencies
      - run:
          name: Install theme dependencies
          command: composer install -o --no-progress --prefer-dist --no-interaction
          working_directory: /src/site/web/app/themes/sd-theme
      # Save the install to the workspace
      - persist_to_workspace:
          root: /src/site
          paths:
            - web/
            - tests/
            - composer.*
            - phpcs.xml
            - phpstan.neon
            - vendor/
            - config/

  # Test php
  check-php:
    working_directory: /app
    docker:
      - image: php:7.3-alpine
    steps:
      # Get the pre-built app
      - attach_workspace:
          at: .
      # Install composer again
      - run: apk add --no-progress composer
      # Run test
      - run: composer check

  analyse-php:
    working_directory: /app
    environment:
      DB_USER: test
      DB_PASSWORD: password
      DB_HOST: localhost
      DB_NAME: ci_development
    docker:
      - image: php:7.3-alpine
      - image: mariadb:10.2
        environment:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_USER: $DB_USER
          MYSQL_PASSWORD: $DB_PASSWORD
          MYSQL_DATABASE: $DB_NAME
    steps:
      # Get the pre-built app
      - attach_workspace:
          at: .
      # Install php deps
      - run: apk add --no-progress libpng-dev libxml2-dev libzip-dev composer git
      # Install php deps
      - run: docker-php-ext-install gd mysqli opcache xmlrpc zip
      # Run analysis
      - run: composer analyse

  # Test plugin deps
  frontend-plugin:
    working_directory: /app
    docker:
      - image: node:10-stretch
    steps:
      - checkout
      - run: yarn --cwd site/web/app/mu-plugins/skin-deep install
      - run: yarn --cwd site/web/app/mu-plugins/skin-deep test

  # Test plugin deps
  frontend-theme:
    working_directory: /app
    docker:
      - image: node:10-stretch
    steps:
      - checkout
      - run: yarn --cwd site/web/app/themes/sd-theme install
      - run: yarn --cwd site/web/app/themes/sd-theme test

workflows:
  version: 2
  web:
    jobs:
      - install-php
      - check-php:
          requires:
            - install-php
      - analyse-php:
          requires:
            - install-php
  frontend:
    jobs:
      - frontend-plugin
      - frontend-theme