# State version
version: 2.0
jobs:
  # Install php dependencies
  install-php:
    docker:
      - image: php:7.3-alpine
    steps:
      # Now checkout the code
      - checkout:
          path: /src
      # Install composer
      - run: apk add --no-progress composer
      # Install bedrock dependencies
      - run:
          name: Install bedrock dependencies
          command: composer install -o --no-progress --prefer-dist --no-interaction
          working_directory: /src/site
      # Install plugin dependencies
      - run:
          name: Install plugin dependencies
          command: composer install -o --no-progress --prefer-dist --no-interaction
          working_directory: /src/site/web/app/mu-plugins/skin-deep
      # Install theme dependencies
      - run:
          name: Install theme dependencies
          command: composer install -o --no-progress --prefer-dist --no-interaction
          working_directory: /src/site/web/app/themes/sd-theme
      # Save the install to the workspace
      - persist_to_workspace:
          root: /src/site
          paths:
            - web/
            - tests/
            - composer.*
            - phpcs.xml
            - phpstan.neon
            - vendor/
            - config/

  # Test php
  check-php:
    working_directory: /app
    docker:
      - image: php:7.3-alpine
    steps:
      # Get the pre-built app
      - attach_workspace:
          at: .
      # Install composer again
      - run: apk add --no-progress composer
      # Run test
      - run: composer check

  # Run e2e tests
  e2e:
    working_directory: /app
    docker:
      - image: cypress/included:3.2.0
    steps:
      - run:
          name: Install Docker Compose
          command: |
            curl -L https://github.com/docker/compose/releases/download/1.19.0/docker-compose-`uname -s`-`uname -m` > ~/docker-compose
            chmod +x ~/docker-compose
            sudo mv ~/docker-compose /usr/local/bin/docker-compose
      - setup_remote_docker
      # Get the pre-built app
      - attach_workspace:
          at: .
      - run:
          name: Run system
          command: docker-compose up -d
          working_directory: /app/tests
      - run:
          command: yarn run
          working_directory: /app/tests

  # Test plugin deps
  frontend-plugin:
    working_directory: /app
    docker:
      - image: node:10-stretch
    steps:
      - checkout
      - run: yarn --cwd site/web/app/mu-plugins/skin-deep install
      - run: yarn --cwd site/web/app/mu-plugins/skin-deep test

  # Test theme deps
  frontend-theme:
    working_directory: /app
    docker:
      - image: node:10-stretch
    steps:
      - checkout
      - run: yarn --cwd site/web/app/themes/sd-theme install
      - run: yarn --cwd site/web/app/themes/sd-theme test

workflows:
  version: 2
  web:
    jobs:
      - install-php
      - check-php:
          requires:
            - install-php
      - e2e:
          requires:
            - install-php
  frontend:
    jobs:
      - frontend-plugin
      - frontend-theme